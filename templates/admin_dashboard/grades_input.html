{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block title %}Checklist - Grades{% endblock %}
{% block css %}
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"> -->
<link rel="stylesheet" href="{% static 'css/checklist.css' %}">
{% endblock %}

{% block content %}

<div class="container mt-4">
  <div class="header">
    <h5>CERTIFICATE OF GRADES</h5>
    <hr>
  </div>

  <div class="row">
    {% if student %}
    <div class="col-md-6">
      <div class="d-flex align-items-center mb-2">
        <p class="mb-0 me-2"><strong>Student No.:</strong></p>
        <div class="input-group w-auto">
            <input type="text" name="student_number" class="form-control d-inline w-auto" placeholder="20xxxxxxx">
            <button class="search-btn">Search</button>
        </div>
      </div class="student-info">
      <p><strong>Full Name:</strong><span class="student-fullname">{{ student.firstname }} {{ student.middlename|default:'' }} {{ student.student.lastname }} {{ student.suffix|default:'' }}</span></p>
      <p><strong>Year Level:</strong><span class="student-year">{{ student.year }}</span></p>
      <p><strong>Degree:</strong><span class="student-course">{{ student.course }}</span></p>
      <p><strong>Date:</strong><span class="student-date">{{ date|date:"F j, Y" }}</span></p>
    </div>
    <div class="col-md-6">
      <p><strong>Academic Year:</strong> 
        <select class="form-select d-inline w-auto">
          {% for year in academic_years %}
            <option>{{ year }}</option>
          {% endfor %}
        </select>
      </p>
    </div>
    {% endif %}
  </div>

  <table class="table table-custom">
    <thead>
      <tr>
        <th>Course Code</th>
        <th>Units</th>
        <th>Course Title</th>
        <th>Grades</th>
        <th>Remarks</th>
        <th>Instructors</th>
      </tr>
    </thead>
    <tbody>
      {% if subject %}
      <tr>
        <td>
          <select class="form-select">
            <option value="" selected>None</option>
            {% for subjects in subject %}
            <option value="{{ subjects.id }}">{{ subjects.course_code }}</option>
            {% endfor %}
          </select>
        </td>
        <td>{{ subject.subject_units_lec }}|{{ subject.subject_units_lab }}</td>
        <td>{{ subject.course_title }}</td>
        <td><input type="text" class="form-control" name="grades"></td>
        <td>{% if grades < 4 and grades >= 1 %}
          Passed
      {% elif grades == 4 %}
          Incomplete
      {% elif grades == 5 %}
          Failed
      {% else %}
          Invalid
      {% endif %}
        <td>
          <select class="form-select">
            <option value="" selected>None</option>
            {% for instructor in instructors %}
            <option value="{{ instructor.id }}">{{ instructor.name }}</option>
            {% endfor %}
          </select>
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>

  <div class="actions">
    <button class="btn btn-outline-secondary">More Subjects</button>
  </div>

  <div class="summary">
    <p><strong>Total subjects enrolled:</strong> __________</p>
    <p><strong>Total credits enrolled:</strong> __________</p>
    <p><strong>Grade Point Average:</strong> __________</p>
  </div>

  <div class="actions">
    <button class="btn btn-primary">Submit and Print COG</button>
  </div>
</div>
<script>
  document.querySelector('#student-form').addEventListener('submit', function (event) {
    event.preventDefault(); // Prevent form from submitting normally

    // Use FormData to collect input values
    const formData = new FormData(event.target);
    const studentNumber = formData.get('student_number');

    if (!studentNumber) {
        alert("Please enter a student number.");
        return;
    }

    fetch(`/fetch-student-data/?student_number=${encodeURIComponent(studentNumber)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error(data.error);
                alert(data.error);
            } else {
                // Dynamically update student information
                document.querySelector('.student-fullname').innerText = 
                    `${data.firstname} ${data.middlename || ''} ${data.lastname} ${data.suffix || ''}`;
                document.querySelector('.student-year').innerText = data.year;
                document.querySelector('.student-course').innerText = data.course;
                document.querySelector('.current-date').innerText = data.current_date;
            }
        })
        .catch(error => console.error('Fetch error:', error));
});
  function updateSubjectDropdown(programId) {
    fetch(`/fetch-subjects/?program_id=${programId}`)
        .then(response => response.json())
        .then(subjects => {
            const dropdown = document.querySelector('select.form-select');
            dropdown.innerHTML = subjects.map(subject => 
                `<option value="${subject.id}">${subject.course_code} - ${subject.course_title}</option>`
            ).join('');
        });
  }
  document.querySelector('.btn-outline-secondary').addEventListener('click', function () {
    const tableBody = document.querySelector('tbody');
    const newRow = `
        <tr>
        <td>
          <select class="form-select">
            <option value="" selected>None</option>
            {% for subjects in subject %}
            <option value="{{ subjects.id }}">{{ subjects.course_code }}</option>
            {% endfor %}
          </select>
        </td>
        <td></td>
        <td></td>
        <td><input type="text" class="form-control"></td>
        <td></td>
        <td>
          <select class="form-select">
            <option value="" selected>None</option>
            {% for instructor in instructors %}
            <option value="{{ isntructor.id }}">{{ instructor.name }}</option>
            {% endfor %}
          </select>
        </td>
      </tr>
    `;
    tableBody.insertAdjacentHTML('beforeend', newRow);
  });
  document.querySelectorAll('select.form-select').forEach(dropdown => {
    dropdown.addEventListener('change', function () {
        updateSummary();
    });
});

function updateSummary() {
    const rows = document.querySelectorAll('tbody tr');
    let totalUnits = 0, totalSubjects = 0, totalGPA = 0;

    rows.forEach(row => {
        const units = parseFloat(row.querySelector('.units').innerText) || 0;
        const grade = parseFloat(row.querySelector('input').value) || 0;

        totalUnits += units;
        totalSubjects++;
        totalGPA += grade;
    });

    document.querySelector('.summary').innerHTML = `
        <p><strong>Total subjects enrolled:</strong> ${totalSubjects}</p>
        <p><strong>Total credits enrolled:</strong> ${totalUnits}</p>
        <p><strong>Grade Point Average:</strong> ${(totalGPA / totalSubjects).toFixed(2)}</p>
    `;
  }
</script>
{% endblock %}